<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="{{ base_path }}/static/favicon.svg">
    <title>Cartera - Sistema Weinstein</title>
    <link rel="stylesheet" href="{{ base_path }}/static/style.css">
    <style>
        .pnl-positive { color: #10b981; font-weight: 600; }
        .pnl-negative { color: #ef4444; font-weight: 600; }
        .stop-triggered-row { background: #fff5f5 !important; }
        .stop-triggered-row td { border-left: 3px solid #ef4444; }
        .inline-form {
            background: #f0f4ff;
            border: 1px solid #c7d2fe;
            border-radius: 0.5rem;
            padding: 1rem 1.25rem;
            margin: 0.5rem 0;
        }
        .inline-form .form-row {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        .inline-form .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .inline-form label {
            font-size: 0.8rem;
            color: #4b5563;
            font-weight: 500;
        }
        .inline-form input {
            padding: 0.375rem 0.625rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            width: 140px;
        }
        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 1.5rem;
        }
        .tab-btn {
            padding: 0.625rem 1.5rem;
            border: none;
            background: transparent;
            color: #6b7280;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        .tab-btn.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        .buy-form-card {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: none;
        }
        .buy-form-card h4 {
            margin: 0 0 1rem 0;
            color: #15803d;
        }
        .buy-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .buy-form-grid .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .buy-form-grid label {
            font-size: 0.8rem;
            color: #4b5563;
            font-weight: 500;
        }
        .buy-form-grid input, .buy-form-grid textarea {
            padding: 0.375rem 0.625rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        .total-row { font-weight: 700; background: #f9fafb; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <h1>üìä Sistema Weinstein</h1>
            </div>
            <div class="nav-menu">
                <a href="{{ base_path }}/">Dashboard</a>
                <a href="{{ base_path }}/stocks">Acciones</a>
                <a href="{{ base_path }}/signals">Se√±ales</a>
                <a href="{{ base_path }}/watchlist">Watchlist</a>
                <a href="{{ base_path }}/portfolio" class="active">Cartera</a>
                <a href="{{ base_path }}/admin">Admin</a>
                <a href="{{ base_path }}/logout">Salir</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <div>
                <h2>üíº Cartera</h2>
                <p class="subtitle">Seguimiento de posiciones y rendimiento</p>
            </div>
            <button class="btn btn-primary" onclick="toggleBuyForm()">+ Nueva posici√≥n</button>
        </div>

        <!-- Formulario nueva compra -->
        <div id="buy-form-card" class="buy-form-card">
            <h4>Nueva posici√≥n de compra</h4>
            <div class="buy-form-grid">
                <div class="form-group">
                    <label for="bf-ticker">Ticker</label>
                    <input type="text" id="bf-ticker" placeholder="Ej: AAPL" style="text-transform:uppercase;">
                </div>
                <div class="form-group">
                    <label for="bf-date">Fecha entrada</label>
                    <input type="date" id="bf-date">
                </div>
                <div class="form-group">
                    <label for="bf-price">Precio compra</label>
                    <input type="number" id="bf-price" step="0.01" min="0.01" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label for="bf-qty">Cantidad (acciones)</label>
                    <input type="number" id="bf-qty" step="0.01" min="0.01" placeholder="0">
                </div>
                <div class="form-group">
                    <label for="bf-stop">Stop Loss</label>
                    <input type="number" id="bf-stop" step="0.01" min="0.01" placeholder="0.00">
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label for="bf-notes">Notas (opcional)</label>
                    <input type="text" id="bf-notes" placeholder="Observaciones...">
                </div>
            </div>
            <div id="buy-form-error" class="alert alert-error" style="display:none; margin-bottom:0.75rem;"></div>
            <div style="display:flex; gap:0.75rem;">
                <button class="btn btn-primary" onclick="saveBuy()">Guardar compra</button>
                <button class="btn btn-cancel" onclick="toggleBuyForm()">Cancelar</button>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üíº</div>
                <div class="stat-content">
                    <div class="stat-value" id="stat-open">-</div>
                    <div class="stat-label">Posiciones abiertas</div>
                </div>
            </div>
            <div class="stat-card blue">
                <div class="stat-icon">üí∞</div>
                <div class="stat-content">
                    <div class="stat-value" id="stat-invested">-</div>
                    <div class="stat-label">Capital invertido</div>
                </div>
            </div>
            <div class="stat-card" id="stat-pnl-card">
                <div class="stat-icon">üìà</div>
                <div class="stat-content">
                    <div class="stat-value" id="stat-pnl">-</div>
                    <div class="stat-label">P&L total abierto</div>
                </div>
            </div>
            <div class="stat-card" id="stat-avg-card">
                <div class="stat-icon">%</div>
                <div class="stat-content">
                    <div class="stat-value" id="stat-avg">-</div>
                    <div class="stat-label">Rentabilidad media abiertas</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-content">
                    <div class="stat-value" id="stat-closed-pnl">-</div>
                    <div class="stat-label">P&L cerradas acumulado</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üèÜ</div>
                <div class="stat-content">
                    <div class="stat-value" id="stat-global-pnl">-</div>
                    <div class="stat-label">P&L global (todas)</div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('open')">Posiciones abiertas</button>
            <button class="tab-btn" onclick="switchTab('history')">Historial cerradas</button>
        </div>

        <!-- TAB: Posiciones abiertas -->
        <div id="tab-open" class="tab-panel active">
            <div id="portfolio-alert" class="alert" style="display:none;"></div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Ticker</th>
                            <th>Fecha entrada</th>
                            <th>Precio compra</th>
                            <th>Cantidad</th>
                            <th>Precio actual</th>
                            <th>P&L ‚Ç¨</th>
                            <th>P&L %</th>
                            <th>Stop Loss</th>
                            <th>Dist. stop</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="open-positions-tbody">
                        <tr><td colspan="10" class="text-center">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- TAB: Historial -->
        <div id="tab-history" class="tab-panel">
            <div style="display:flex; justify-content:flex-end; margin-bottom:1rem;">
                <button class="btn btn-danger" onclick="clearHistory()">Borrar historial</button>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Ticker</th>
                            <th>Entrada</th>
                            <th>Salida</th>
                            <th>Precio compra</th>
                            <th>Precio venta</th>
                            <th>Cantidad</th>
                            <th>P&L ‚Ç¨</th>
                            <th>P&L %</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="history-tbody">
                        <tr><td colspan="9" class="text-center">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>Sistema Weinstein v0.3.0 - Trading Algor√≠tmico</p>
            <p class="footer-disclaimer">‚ö†Ô∏è Este sistema es educativo. No constituye asesoramiento financiero.</p>
        </div>
    </footer>

    <script>window.BASE_PATH = "{{ base_path }}";</script>
    <script src="{{ base_path }}/static/portfolio.js"></script>
</body>
</html>
